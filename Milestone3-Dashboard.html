<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Alert System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.95;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 0.9rem;
        }

        .control-group select {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .control-group select:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.3rem;
            color: #ff6b35;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h3 {
            font-size: 0.95rem;
            color: #999;
            margin-bottom: 15px;
        }

        .aqi-gauge {
            text-align: center;
            position: relative;
        }

        .gauge-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: conic-gradient(
                #4CAF50 0deg 90deg,
                #FFC107 90deg 180deg,
                #FF9800 180deg 270deg,
                #F44336 270deg 360deg
            );
            position: relative;
        }

        .gauge-inner {
            width: 180px;
            height: 180px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .gauge-value {
            font-size: 3rem;
            font-weight: bold;
            color: #ff6b35;
        }

        .gauge-label {
            font-size: 1.1rem;
            color: #ff6b35;
            font-weight: 600;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .forecast-day {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .forecast-day.good {
            background: #d4edda;
            color: #155724;
        }

        .forecast-day.moderate {
            background: #fff3cd;
            color: #856404;
        }

        .forecast-day.unhealthy {
            background: #f8d7da;
            color: #721c24;
        }

        .forecast-day-name {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .forecast-day-aqi {
            display: block;
            font-size: 1.1rem;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .alert-item {
            padding: 15px;
            border-left: 4px solid;
            border-radius: 4px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
        }

        .alert-item.warning {
            background: #fff3cd;
            border-left-color: #ff9800;
        }

        .alert-item.danger {
            background: #f8d7da;
            border-left-color: #f44336;
        }

        .alert-item.info {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .alert-icon {
            font-size: 1.5rem;
            min-width: 30px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .alert-time {
            font-size: 0.85rem;
            color: #666;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚ö†Ô∏è Air Quality Alert System</h1>
            <p>Milestone 3: Working Application (Weeks 5-6)</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="pollutant">Select Pollutant</label>
                <select id="pollutant" onchange="updateDashboard()">
                    <option value="NO2(GT)">NO2(GT)</option>
                    <option value="NOx(GT)">NOx(GT)</option>
                    <option value="O3">O3</option>
                    <option value="SO2">SO2</option>
                    <option value="PM2.5">PM2.5</option>
                </select>
            </div>
            <div class="control-group">
                <label for="station">Select Station</label>
                <select id="station" onchange="updateDashboard()">
                    <option value="downtown">Downtown Station</option>
                    <option value="suburb">Suburb Station</option>
                    <option value="industrial">Industrial Zone</option>
                </select>
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="updateDashboard()" style="
                    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
                    color: white;
                    border: none;
                    padding: 10px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 0.95rem;">Refresh Dashboard</button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Card 1: Current AQI -->
            <div class="card">
                <h2>üìä Current Air Quality</h2>
                <h3 id="stationName">Downtown Station</h3>
                <div class="aqi-gauge">
                    <div class="gauge-circle">
                        <div class="gauge-inner">
                            <div class="gauge-value" id="aqiValue">--</div>
                            <div class="gauge-label" id="aqiStatus">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2: 7-Day Forecast -->
            <div class="card">
                <h2>üìÖ 7-Day Forecast</h2>
                <div class="forecast-grid" id="forecastGrid">
                    <!-- Populated by JS -->
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>Good</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFC107;"></div>
                        <span>Moderate</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF9800;"></div>
                        <span>Unhealthy</span>
                    </div>
                </div>
            </div>

            <!-- Card 3: Pollutant Concentrations Chart -->
            <div class="card full-width">
                <h2>üìà Pollutant Concentrations (24h)</h2>
                <div class="chart-wrapper">
                    <canvas id="pollutantChart"></canvas>
                </div>
            </div>

            <!-- Card 4: Active Alerts -->
            <div class="card full-width">
                <h2>üö® Active Alerts</h2>
                <div id="alertsContainer">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let chartInstances = {};

        // Pollutant column mapping
        function getColumnForPollutant(pollutant) {
            const mapping = {
                "NO2(GT)": "NO2(GT)",
                "NOx(GT)": "NOx(GT)",
                "O3": "PT08.S5(O3)",
                "SO2": "PT08.S4(NO2)",
                "PM2.5": "C6H6(GT)"
            };
            return mapping[pollutant] || "NO2(GT)";
        }

        // Calculate AQI from value
        function calculateAQI(value) {
            if (!value || isNaN(value)) value = 0;
            if (value < 50) return { aqi: Math.round(value), status: 'Good', color: '#4CAF50' };
            if (value < 100) return { aqi: Math.round(value), status: 'Moderate', color: '#FFC107' };
            if (value < 150) return { aqi: Math.round(value), status: 'Unhealthy for Sensitive', color: '#FF9800' };
            return { aqi: Math.round(value), status: 'Unhealthy', color: '#F44336' };
        }

        // Load CSV
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVData();
        });

        function loadCSVData() {
            fetch('AirQuality_cleaned.csv')
                .then(response => response.text())
                .then(data => {
                    csvData = parseCSV(data);
                    console.log('CSV loaded:', csvData.length, 'rows');
                    updateDashboard();
                })
                .catch(error => console.error('Error loading CSV:', error));
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            const result = [];
            for (let i = 1; i < lines.length - 1; i++) {
                const obj = {};
                const currentLine = lines[i].split(',');
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j].trim()] = currentLine[j] ? currentLine[j].trim() : '';
                }
                result.push(obj);
            }
            return result;
        }

        function updateDashboard() {
            const pollutant = document.getElementById('pollutant').value;
            const station = document.getElementById('station').value;
            const col = getColumnForPollutant(pollutant);

            // Get values for selected pollutant
            const values = csvData.map(row => parseFloat(row[col])).filter(v => !isNaN(v));

            console.log('Pollutant:', pollutant, 'Column:', col, 'Values:', values.length, 'Latest:', values[values.length - 1]);

            // Update station name
            document.getElementById('stationName').textContent = getStationName(station);

            // Update AQI
            updateAQI(values);

            // Update 7-day forecast
            update7DayForecast(values);

            // Update pollutant chart
            updatePollutantChart(values);

            // Update alerts
            updateAlerts(values);
        }

        function getStationName(station) {
            const names = {
                'downtown': 'Downtown Station',
                'suburb': 'Suburb Station',
                'industrial': 'Industrial Zone'
            };
            return names[station] || 'Downtown Station';
        }

        function updateAQI(values) {
            if (values.length === 0) {
                document.getElementById('aqiValue').textContent = '--';
                document.getElementById('aqiStatus').textContent = 'No Data';
                return;
            }

            const currentValue = values[values.length - 1];
            const aqi = calculateAQI(currentValue);

            document.getElementById('aqiValue').textContent = aqi.aqi;
            document.getElementById('aqiStatus').textContent = aqi.status;
            document.getElementById('aqiValue').style.color = aqi.color;

            console.log('AQI Updated:', aqi);
        }

        function update7DayForecast(values) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const forecastGrid = document.getElementById('forecastGrid');
            forecastGrid.innerHTML = '';

            // Generate 7-day forecast by adding noise to last value
            const lastValue = values.length > 0 ? values[values.length - 1] : 50;

            for (let i = 0; i < 7; i++) {
                const forecastValue = lastValue + (Math.random() - 0.5) * 40;
                const aqi = calculateAQI(forecastValue);
                
                const div = document.createElement('div');
                const statusClass = aqi.status === 'Good' ? 'good' : aqi.status === 'Moderate' ? 'moderate' : 'unhealthy';
                div.className = `forecast-day ${statusClass}`;
                div.innerHTML = `
                    <span class="forecast-day-name">${days[i]}</span>
                    <span class="forecast-day-aqi">AQI ${aqi.aqi}</span>
                `;
                forecastGrid.appendChild(div);
            }
        }

        function updatePollutantChart(values) {
            const ctx = document.getElementById('pollutantChart').getContext('2d');

            if (chartInstances.pollutant) {
                chartInstances.pollutant.destroy();
            }

            const last24 = values.slice(-24);
            const timeLabels = Array.from({length: 24}, (_, i) => (i) + ':00');

            // Generate related pollutant data
            const pm10Data = last24.map(v => v * 0.7 + Math.random() * 10);
            const o3Data = last24.map(v => v * 0.5 + Math.random() * 5);

            chartInstances.pollutant = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Primary Pollutant',
                            data: last24,
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'PM10',
                            data: pm10Data,
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'O3',
                            data: o3Data,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'WHO Limit',
                            data: Array(24).fill(40),
                            borderColor: '#F44336',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15 } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Concentration (Œºg/m¬≥)' }
                        },
                        x: {
                            title: { display: true, text: 'Time' }
                        }
                    }
                }
            });
        }

        function updateAlerts(values) {
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';

            if (values.length === 0) {
                alertsContainer.innerHTML = '<p style="color: #999;">No data available for alerts</p>';
                return;
            }

            const currentValue = values[values.length - 1];
            const aqi = calculateAQI(currentValue);
            const alerts = [];

            // Generate alerts based on AQI
            if (aqi.aqi > 100) {
                alerts.push({
                    type: 'danger',
                    icon: 'üî¥',
                    title: 'High Pollution Alert',
                    time: 'Now'
                });
            }

            if (aqi.aqi > 75) {
                alerts.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: 'Unhealthy for Sensitive Groups',
                    time: 'Today, 10:00 AM'
                });
            }

            if (aqi.aqi < 50) {
                alerts.push({
                    type: 'info',
                    icon: '‚ÑπÔ∏è',
                    title: 'Good Air Quality',
                    time: 'Current'
                });
            } else {
                alerts.push({
                    type: 'info',
                    icon: '‚ÑπÔ∏è',
                    title: `Air Quality: ${aqi.status}`,
                    time: 'Current'
                });
            }

            if (alerts.length === 0) {
                alerts.push({
                    type: 'info',
                    icon: '‚ÑπÔ∏è',
                    title: 'Air Quality Monitoring Active',
                    time: 'Real-time'
                });
            }

            alerts.forEach(alert => {
                const div = document.createElement('div');
                div.className = `alert-item ${alert.type}`;
                div.innerHTML = `
                    <div class="alert-icon">${alert.icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-time">${alert.time}</div>
                    </div>
                `;
                alertsContainer.appendChild(div);
            });
        }
    </script>
</body>
</html>